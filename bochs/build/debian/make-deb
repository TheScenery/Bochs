#!/bin/bash -x
#########################################################################
# $Id$
#########################################################################
# build/debian/make-deb
#
# This script creates an DEB from the bochs directory.  You must run
# it as root from the top of the source directory (where the configure
# scripts are).  Then just run:
#    ./build/debian/make-deb
#
#########################################################################

CAT=cat
RM=rm
CP=cp
MV=mv
MKDIR=mkdir
CAT=cat
GREP=grep
ECHO=echo
DEB=deb
SED=sed
TAR=tar
GZIP_BIN=gzip
CHMOD=chmod
INSTALL=install
CHOWN=chown
CHGRP=chgrp

prefix=/usr/local
exec_prefix=${prefix}
srcdir=.

VERSION=$(${CAT} Makefile | ${GREP} -P -o '(?<=VERSION=).+')

bindir=${exec_prefix}/bin
libdir=${exec_prefix}/lib
plugdir=${exec_prefix}/lib/bochs/plugins
datarootdir=${prefix}/share
mandir=${datarootdir}/man
man1dir=${mandir}/man1
man5dir=${mandir}/man5
docdir=${datarootdir}/doc/bochs
sharedir=${datarootdir}/bochs
top_builddir=.
top_srcdir=${srcdir}

DEBROOTPATH=build_rootpath/_deb_top
DESTDIR=${DEBROOTPATH}
DEBIANPATH=${DEBROOTPATH}/DEBIAN
DEBBINPATH=${DEBROOTPATH}${bindir}
DEBSHAREPATH=${DEBROOTPATH}${sharedir}
CONTROLTEMPLATE="build/debian/bochs.control.template"
TMPDIR=/tmp
MAN_PAGE_1_LIST=(bochs bximage bochs-dlx)
MAN_PAGE_5_LIST=(bochsrc)
INSTALL_LIST_SHARE=(bios/BIOS-bochs-* bios/VGABIOS* bios/SeaBIOS* bios/SeaVGABIOS* bios/bios.bin-* bios/vgabios-cirrus.bin-*)
INSTALL_LIST_DOC=(CHANGES COPYING LICENSE README TODO misc/slirp.conf misc/vnet.conf)
INSTALL_LIST_BIN=(bochs bximage)
INSTALL_LIST_BIN_OPTIONAL=(bochsdbg)

# clean up previous deb builds
${RM} -rf *.deb ${DEBROOTPATH}
if test -f Makefile; then
  make dist-clean
fi

build bochs
./configure --enable-debugger --enable-debugger-gui --enable-x86-debugger
make

# create build directory
${MKDIR} -p ${DEBIANPATH}

# generate control file
${CAT} ${CONTROLTEMPLATE} >${DEBIANPATH}/control


# copy artifacts
# copy bin
for i in ${DESTDIR}${bindir}; do mkdir -p $i && test -d $i && test -w $i; done
for i in ${INSTALL_LIST_BIN[@]}; do ${INSTALL} $i ${DESTDIR}${bindir}; done
for i in ${INSTALL_LIST_BIN_OPTIONAL[@]}; do if test -f $i; then ${INSTALL} $i ${DESTDIR}${bindir}; fi; done

# copy man
${MKDIR} -p ${DESTDIR}${man1dir}
${MKDIR} -p ${DESTDIR}${man5dir}

for i in ${MAN_PAGE_1_LIST[@]}
do
${CAT} ${srcdir}/doc/man/$i.1 | ${SED} "s/@version@/${VERSION}/g" | ${GZIP_BIN} -c > ${DESTDIR}${man1dir}/$i.1.gz
${CHMOD} 644 ${DESTDIR}${man1dir}/$i.1.gz
done

for i in ${MAN_PAGE_5_LIST[@]}
do
${CAT} ${srcdir}/doc/man/$i.5 | ${GZIP_BIN} -9 -c > ${DESTDIR}${man1dir}/$i.5.gz
${CHMOD} 644 ${DESTDIR}${man1dir}/$i.5.gz
done

# copy share
for i in ${DESTDIR}${sharedir}; do mkdir -p $i && test -d $i && test -w $i; done
for i in ${INSTALL_LIST_SHARE[@]}
do
${INSTALL} -m 644 $i ${DESTDIR}${sharedir}
done
${MKDIR} ${DESTDIR}${sharedir}/keymaps
for i in ${srcdir}/gui/keymaps/*.map
do
${INSTALL} -m 644 $i ${DESTDIR}${sharedir}/keymaps
done

# copy doc
for i in ${DESTDIR}${docdir}; do mkdir -p $i && test -d $i && test -w $i; done
for i in ${INSTALL_LIST_DOC[@]}
do
${INSTALL} -m 644 $i ${DESTDIR}${docdir}
done
${RM} -f ${DESTDIR}${docdir}/README
${CAT} ${srcdir}/build/linux/README.linux-binary ${srcdir}/README > ${DESTDIR}${docdir}/README
${INSTALL} -m 644 ${srcdir}/.bochsrc ${DESTDIR}${docdir}/bochsrc-sample.txt

# change owner and group to root
${CHOWN} -R root ${DESTDIR}
${CHGRP} -R root ${DESTDIR}
# generate deb file
dpkg -b ${DESTDIR} bochs-debug_${VERSION}_all.deb